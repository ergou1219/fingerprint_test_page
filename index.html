<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浏览器指纹测试 - 考勤系统专用</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .fingerprint-display {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .fingerprint-hash {
            background: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 10px;
        }

        .confidence-bar {
            margin-top: 15px;
        }

        .confidence-fill {
            height: 30px;
            background: linear-gradient(90deg, #48bb78, #38a169);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s ease;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: normal;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
        }

        .info-value {
            color: #2d3748;
            font-size: 14px;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .test-button:hover {
            background: #5568d3;
        }

        .test-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .array-value {
            font-size: 12px;
            color: #4a5568;
            max-height: 60px;
            overflow-y: auto;
        }

        .hash-preview {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 浏览器指纹测试系统</h1>
            <p class="subtitle">专为考勤系统设计的高准确度设备识别方案</p>
            <button class="test-button" onclick="regenerateFingerprint()">🔄 重新生成指纹</button>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div>正在收集设备特征...</div>
        </div>

        <div id="content" style="display: none;">
            <div class="fingerprint-display">
                <h2 style="color: #333; margin-bottom: 10px;">设备指纹</h2>
                <div class="fingerprint-hash" id="fingerprintHash"></div>
                
                <div class="confidence-bar">
                    <div style="color: #666; margin-bottom: 5px; font-size: 14px;">置信度评分</div>
                    <div class="confidence-fill" id="confidenceBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid" id="componentsGrid"></div>
        </div>
    </div>

    <script>
        class AttendanceFingerprint {
            constructor() {
                this.components = {};
            }

            async generate() {
                try {
                    const [canvas, webgl, audio, fonts] = await Promise.all([
                        this.getCanvasFingerprint(),
                        this.getWebGLFingerprint(),
                        this.getAudioFingerprint(),
                        this.getFonts()
                    ]);

                    this.components = {
                        canvas,
                        webgl,
                        audio,
                        fonts,
                        screen: this.getScreenFingerprint(),
                        hardware: this.getHardwareInfo(),
                        timezone: this.getTimezone(),
                        language: this.getLanguage(),
                        platform: this.getPlatform(),
                        storage: await this.getStorageFingerprint(),
                        media: await this.getMediaDevices(),
                        network: this.getNetworkInfo()
                    };

                    const fingerprint = await this.hash(JSON.stringify(this.components));
                    const componentHashes = await this.getComponentHashes();

                    return {
                        fingerprint,
                        components: this.components,
                        componentHashes,
                        confidence: this.calculateConfidence(),
                        timestamp: Date.now()
                    };
                } catch (error) {
                    console.error('指纹生成失败:', error);
                    throw error;
                }
            }

            async getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 240;
                    canvas.height = 140;

                    ctx.textBaseline = 'top';
                    ctx.font = '16px "Arial"';
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    
                    ctx.fillStyle = '#069';
                    ctx.fillText('浏览器指纹🎨', 2, 15);
                    
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('AttendanceCheck', 4, 45);

                    ctx.globalCompositeOperation = 'multiply';
                    ctx.fillStyle = 'rgb(255,0,255)';
                    ctx.beginPath();
                    ctx.arc(50, 50, 50, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = 'rgb(0,255,255)';
                    ctx.beginPath();
                    ctx.arc(100, 50, 50, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.fill();

                    const dataURL = canvas.toDataURL();
                    const hash = await this.hash(dataURL);
                    return { hash, length: dataURL.length };
                } catch (e) {
                    return { error: e.message };
                }
            }

            getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (!gl) return { error: 'WebGL不支持' };

                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    return {
                        vendor: gl.getParameter(gl.VENDOR),
                        renderer: gl.getParameter(gl.RENDERER),
                        version: gl.getParameter(gl.VERSION),
                        shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                        unmaskedVendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown',
                        unmaskedRenderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown',
                        maxTextureSize: gl.getParameter(gl.MAX_TEXTURE_SIZE),
                        maxViewportDims: Array.from(gl.getParameter(gl.MAX_VIEWPORT_DIMS)),
                        maxVertexAttribs: gl.getParameter(gl.MAX_VERTEX_ATTRIBS)
                    };
                } catch (e) {
                    return { error: e.message };
                }
            }

            async getAudioFingerprint() {
                return new Promise((resolve) => {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (!AudioContext) {
                            resolve({ error: 'AudioContext不支持' });
                            return;
                        }

                        const context = new AudioContext();
                        const oscillator = context.createOscillator();
                        const analyser = context.createAnalyser();
                        const gainNode = context.createGain();
                        const scriptProcessor = context.createScriptProcessor(4096, 1, 1);

                        gainNode.gain.value = 0;
                        oscillator.type = 'triangle';
                        oscillator.frequency.value = 10000;

                        oscillator.connect(analyser);
                        analyser.connect(scriptProcessor);
                        scriptProcessor.connect(gainNode);
                        gainNode.connect(context.destination);

                        scriptProcessor.onaudioprocess = (event) => {
                            const output = event.outputBuffer.getChannelData(0);
                            const sample = Array.from(output.slice(0, 30));
                            
                            oscillator.disconnect();
                            scriptProcessor.disconnect();
                            context.close();
                            
                            this.hash(sample.join(',')).then(hash => {
                                resolve({ hash, sampleSize: sample.length });
                            });
                        };

                        oscillator.start(0);
                        
                        setTimeout(() => {
                            try {
                                oscillator.disconnect();
                                scriptProcessor.disconnect();
                                context.close();
                            } catch (e) {}
                            resolve({ error: '超时' });
                        }, 1000);
                    } catch (e) {
                        resolve({ error: e.message });
                    }
                });
            }

            async getFonts() {
                const baseFonts = ['monospace', 'sans-serif', 'serif'];
                const testFonts = [
                    'Arial', 'Verdana', 'Times New Roman', 'Courier New', 'Georgia',
                    'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS', 'Trebuchet MS',
                    'Impact', 'Arial Black', 'Helvetica', 'Tahoma', 'Lucida Console',
                    'Monaco', 'Consolas', 'Microsoft YaHei', 'SimSun', 'SimHei'
                ];

                const testString = 'mmmmmmmmmmlli';
                const testSize = '72px';
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const baseWidths = {};
                baseFonts.forEach(baseFont => {
                    ctx.font = `${testSize} ${baseFont}`;
                    baseWidths[baseFont] = ctx.measureText(testString).width;
                });

                const detectedFonts = testFonts.filter(font => {
                    return baseFonts.some(baseFont => {
                        ctx.font = `${testSize} '${font}', ${baseFont}`;
                        const width = ctx.measureText(testString).width;
                        return width !== baseWidths[baseFont];
                    });
                });

                return detectedFonts.sort();
            }

            getScreenFingerprint() {
                return {
                    width: screen.width,
                    height: screen.height,
                    availWidth: screen.availWidth,
                    availHeight: screen.availHeight,
                    colorDepth: screen.colorDepth,
                    pixelDepth: screen.pixelDepth,
                    pixelRatio: window.devicePixelRatio,
                    orientation: screen.orientation?.type || 'unknown'
                };
            }

            getHardwareInfo() {
                return {
                    cores: navigator.hardwareConcurrency || 'unknown',
                    memory: navigator.deviceMemory || 'unknown',
                    platform: navigator.platform,
                    maxTouchPoints: navigator.maxTouchPoints || 0
                };
            }

            getTimezone() {
                return {
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset()
                };
            }

            getLanguage() {
                return {
                    language: navigator.language,
                    languages: navigator.languages || [navigator.language]
                };
            }

            getPlatform() {
                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    vendor: navigator.vendor,
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack
                };
            }

            async getStorageFingerprint() {
                const storage = {};
                
                try {
                    storage.localStorage = !!window.localStorage;
                    storage.sessionStorage = !!window.sessionStorage;
                    storage.indexedDB = !!window.indexedDB;
                } catch (e) {
                    storage.error = e.message;
                }

                return storage;
            }

            async getMediaDevices() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    return { error: '不支持' };
                }

                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    return devices.map(d => ({
                        kind: d.kind,
                        groupId: d.groupId
                    }));
                } catch (e) {
                    return { error: e.message };
                }
            }

            getNetworkInfo() {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (!connection) return { error: '不支持' };

                return {
                    effectiveType: connection.effectiveType,
                    downlink: connection.downlink,
                    rtt: connection.rtt,
                    saveData: connection.saveData
                };
            }

            async getComponentHashes() {
                const hashes = {};
                for (const [key, value] of Object.entries(this.components)) {
                    hashes[key] = await this.hash(JSON.stringify(value));
                }
                return hashes;
            }

            calculateConfidence() {
                let score = 0;
                const weights = {
                    canvas: 25,
                    webgl: 25,
                    audio: 20,
                    fonts: 15,
                    screen: 5,
                    hardware: 10
                };

                for (const [key, weight] of Object.entries(weights)) {
                    const component = this.components[key];
                    if (component && !component.error) {
                        score += weight;
                    }
                }

                return score;
            }

            async hash(str) {
                const buffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        }

        // UI 渲染函数
        function renderResults(result) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // 显示指纹
            document.getElementById('fingerprintHash').textContent = result.fingerprint;

            // 显示置信度
            const confidenceBar = document.getElementById('confidenceBar');
            setTimeout(() => {
                confidenceBar.style.width = result.confidence + '%';
                confidenceBar.textContent = result.confidence + '% 置信度';
            }, 100);

            // 渲染组件卡片
            const grid = document.getElementById('componentsGrid');
            grid.innerHTML = '';

            const componentInfo = {
                canvas: { title: 'Canvas 指纹', weight: 25, icon: '🎨' },
                webgl: { title: 'WebGL 指纹', weight: 25, icon: '🖥️' },
                audio: { title: 'Audio 指纹', weight: 20, icon: '🔊' },
                fonts: { title: '字体检测', weight: 15, icon: '🔤' },
                screen: { title: '屏幕信息', weight: 5, icon: '📱' },
                hardware: { title: '硬件信息', weight: 10, icon: '⚙️' },
                timezone: { title: '时区信息', weight: 0, icon: '🌍' },
                language: { title: '语言信息', weight: 0, icon: '🗣️' },
                platform: { title: '平台信息', weight: 0, icon: '💻' },
                storage: { title: '存储信息', weight: 0, icon: '💾' },
                media: { title: '媒体设备', weight: 0, icon: '📹' },
                network: { title: '网络信息', weight: 0, icon: '📡' }
            };

            for (const [key, info] of Object.entries(componentInfo)) {
                const data = result.components[key];
                const hash = result.componentHashes[key];
                const hasError = data && data.error;

                const card = document.createElement('div');
                card.className = 'card';
                
                let statusBadge = '';
                if (info.weight > 0) {
                    statusBadge = hasError 
                        ? `<span class="status-badge status-error">错误</span>`
                        : `<span class="status-badge status-success">权重 ${info.weight}%</span>`;
                } else {
                    statusBadge = hasError
                        ? `<span class="status-badge status-error">错误</span>`
                        : `<span class="status-badge status-warning">辅助</span>`;
                }

                card.innerHTML = `
                    <div class="card-title">
                        <span>${info.icon} ${info.title}</span>
                        ${statusBadge}
                    </div>
                    <div id="component-${key}"></div>
                    <div class="info-row">
                        <span class="info-label">组件哈希</span>
                        <span class="info-value hash-preview">${hash.substring(0, 16)}...</span>
                    </div>
                `;

                grid.appendChild(card);

                const container = document.getElementById(`component-${key}`);
                renderComponentData(container, data);
            }
        }

        function renderComponentData(container, data) {
            if (!data) {
                container.innerHTML = '<div class="info-row"><span class="info-value">无数据</span></div>';
                return;
            }

            if (data.error) {
                container.innerHTML = `<div class="info-row"><span class="info-value" style="color: #e53e3e;">${data.error}</span></div>`;
                return;
            }

            if (Array.isArray(data)) {
                container.innerHTML = `<div class="info-row">
                    <span class="info-label">检测到</span>
                    <span class="info-value">${data.length} 项</span>
                </div>
                <div class="array-value">${data.join(', ')}</div>`;
                return;
            }

            for (const [key, value] of Object.entries(data)) {
                const row = document.createElement('div');
                row.className = 'info-row';
                
                let displayValue = value;
                if (Array.isArray(value)) {
                    displayValue = value.join(', ');
                } else if (typeof value === 'object') {
                    displayValue = JSON.stringify(value);
                } else if (typeof value === 'boolean') {
                    displayValue = value ? '✓ 是' : '✗ 否';
                }

                row.innerHTML = `
                    <span class="info-label">${key}</span>
                    <span class="info-value">${displayValue}</span>
                `;
                container.appendChild(row);
            }
        }

        async function regenerateFingerprint() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            
            const fp = new AttendanceFingerprint();
            const result = await fp.generate();
            
            console.log('完整指纹结果:', result);
            renderResults(result);
        }

        // 页面加载时自动生成
        window.addEventListener('load', regenerateFingerprint);
    </script>
</body>
</html>